# nginx.conf example for vodweb pseudo-static routing
# Adjust server_name, root, and fastcgi_pass to your environment.

server {
    listen 80;
    server_name localhost;
    root X:/wwwroot/127.0.0.1;  # On Linux use /var/www/your-site
    index index.php index.html;

    # Serve static assets directly
    location /assets/ { try_files $uri =404; }
    location /uploads/ { try_files $uri =404; }
    location /cache/ { deny all; }
    # 保护敏感配置文件
    location ~* ^/settings\.json$ { deny all; }

    # Pretty URL rewrites
    # Home and pagination
    rewrite ^/$ /index.php last;
    rewrite ^/page/([0-9]+)/?$ /index.php?pg=$1 last;
    rewrite ^/latest/?$ /index.php?h=24 last;
    rewrite ^/latest/([0-9]+)/?$ /index.php?h=24&pg=$1 last;

    # Category
    rewrite ^/category/([0-9]+)/?$ /category.php?t=$1 last;
    rewrite ^/category/([0-9]+)/([0-9]+)/?$ /category.php?t=$1&pg=$2 last;

    # Search (both path and querystring forms)
    rewrite ^/search/([^/]+)/?$ /search.php?wd=$1 last;
    rewrite ^/search/([^/]+)/([0-9]+)/?$ /search.php?wd=$1&pg=$2 last;
    rewrite ^/search/?$ /search.php last;

    # Detail
    rewrite ^/detail/([0-9]+)/?$ /detail.php?id=$1 last;

    # Play
    rewrite ^/play/([^/]+)/([0-9]+)/?$ /play.php?token=$1&ep=$2 last;

    # Image proxy (URL path segment should be percent-encoded)
    rewrite ^/img/(.+)$ /img.php?url=$1 last;

    # Default handler
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # PHP handler (php-fpm)
    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        # Adjust fastcgi_pass to your php-fpm socket or host:port
        # fastcgi_pass unix:/run/php/php8.2-fpm.sock;
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
    }

    # Security headers (optional)
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;
    add_header Referrer-Policy no-referrer-when-downgrade;
}