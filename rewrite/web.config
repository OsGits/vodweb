<?xml version="1.0" encoding="UTF-8"?>
<configuration>
  <system.webServer>
    <rewrite>
      <rules>
        <!-- 跳过实际存在的文件与目录 -->
        <rule name="Ignore existing files" stopProcessing="true">
          <match url=".*" />
          <conditions logicalGrouping="MatchAll">
            <add input="{REQUEST_FILENAME}" matchType="IsFile" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" />
          </conditions>
          <action type="None" />
        </rule>

        <!-- 首页与分页 -->
        <rule name="Root" stopProcessing="true">
          <match url="^$" />
          <action type="Rewrite" url="/index.php" />
        </rule>
        <rule name="Home pagination" stopProcessing="true">
          <match url="^page/([0-9]+)$" />
          <action type="Rewrite" url="/index.php?pg={R:1}" />
        </rule>
        <rule name="Latest page" stopProcessing="true">
          <match url="^latest(?:/([0-9]+))?$" />
          <action type="Rewrite" url="/index.php?h=24&pg={R:1}" />
        </rule>

        <!-- 分类页 -->
        <rule name="Category with page" stopProcessing="true">
          <match url="^category/([0-9]+)/([0-9]+)$" />
          <action type="Rewrite" url="/category.php?t={R:1}&pg={R:2}" />
        </rule>
        <rule name="Category no page" stopProcessing="true">
          <match url="^category/([0-9]+)$" />
          <action type="Rewrite" url="/category.php?t={R:1}" />
        </rule>

        <!-- 搜索页 -->
        <rule name="Search with page" stopProcessing="true">
          <match url="^search/([^/]+)/([0-9]+)$" />
          <action type="Rewrite" url="/search.php?wd={R:1}&pg={R:2}" />
        </rule>
        <rule name="Search no page" stopProcessing="true">
          <match url="^search/([^/]+)$" />
          <action type="Rewrite" url="/search.php?wd={R:1}" />
        </rule>
        <rule name="Search QS" stopProcessing="true">
          <match url="^search$" />
          <action type="Rewrite" url="/search.php" appendQueryString="true" />
        </rule>

        <!-- 详情页 -->
        <rule name="Detail" stopProcessing="true">
          <match url="^detail/([0-9]+)$" />
          <action type="Rewrite" url="/detail.php?id={R:1}" />
        </rule>

        <!-- 播放页（令牌 + 分集索引） -->
        <rule name="Play token+ep" stopProcessing="true">
          <match url="^play/([^/]+)/([0-9]+)$" />
          <action type="Rewrite" url="/play.php?token={R:1}&ep={R:2}" />
        </rule>

        <!-- 图片代理（路径段需对原始URL进行百分号编码） -->
        <rule name="Image proxy" stopProcessing="true">
          <match url="^img/(.+)$" />
          <action type="Rewrite" url="/img.php?url={R:1}" />
        </rule>
      </rules>
    </rewrite>
  </system.webServer>
</configuration>